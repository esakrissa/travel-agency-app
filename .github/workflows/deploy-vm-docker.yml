name: Deploy Docker to VM for Development

on:
  push:
    branches: [ dev ]

jobs:
  deploy:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v3
      
      - name: Set up SSH
        uses: webfactory/ssh-agent@v0.5.4
        with:
          ssh-private-key: ${{ secrets.SSH_PRIVATE_KEY }}
          
      - name: Add VM to known hosts
        run: |
          mkdir -p ~/.ssh
          ssh-keyscan -H 34.57.0.40 >> ~/.ssh/known_hosts

      - name: Transfer files to VM
        run: |
          # Create deployment directory if it doesn't exist
          ssh esakrissa@34.57.0.40 "mkdir -p ~/travel-agency-app"
          
          # Transfer files
          rsync -avz --exclude 'node_modules' --exclude '.git' ./ esakrissa@34.57.0.40:~/travel-agency-app/

      - name: Deploy to VM with Docker
        run: |
          ssh esakrissa@34.57.0.40 "sudo bash -s" << 'ENDSSH'
          cd ~/travel-agency-app

          # Install Docker if not installed
          if ! command -v docker &> /dev/null; then
            echo "ğŸ”§ Installing Docker..."
            curl -fsSL https://get.docker.com -o get-docker.sh
            sh get-docker.sh
          fi

          # Stop and remove existing container if it exists
          echo "ğŸ§¹ Cleaning up existing container..."
          sudo docker stop travel-agency-dev || true
          sudo docker rm travel-agency-dev || true

          # Build and run new container
          echo "ğŸ—ï¸ Building Docker image..."
          sudo docker build -t travel-agency-dev \
            --build-arg NODE_ENV=development \
            .

          echo "ğŸš€ Starting container..."
          sudo docker run -d \
            --name travel-agency-dev \
            -p 8080:8080 \
            -e NODE_ENV=development \
            --restart unless-stopped \
            travel-agency-dev

          echo "âœ… Deployment completed"
          ENDSSH

      - name: Verify deployment
        run: |
          echo "â³ Waiting for application to start..."
          sleep 10
          echo "ğŸ¥ Checking application health..."
          curl -v http://34.57.0.40:8080/health || echo "Health check failed, but continuing..."
          echo "ğŸ“Š Checking Docker container status..."
          ssh esakrissa@34.57.0.40 "sudo docker ps | grep travel-agency-dev" 